<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dongogong.dao.mybatis.mapper.PostMapper">
  <cache />
  
   <update id="postUpdate" parameterType="Post">
     UPDATE POST SET TITLE = #{title}, CONTENT = #{content}, PRICE = #{price}, PHOTOURL = #{photoUrl}
     WHERE POST_IDX = #{postIdx}
  </update>
  
  <delete id="postDelete" parameterType="java.lang.Integer">
     DELETE
     FROM POST 
     WHERE POST_IDX = #{postIdx}
  </delete>
  
   <delete id="transactionDelete" parameterType="java.lang.Integer">
  	DELETE
  	FROM TRANSACTIONS
  	WHERE POST_IDX = #{postIdx}
  </delete>
  
   <delete id="relationDelete" parameterType="java.lang.Integer">
  	DELETE
  	FROM RELATION
  	WHERE POST_IDX = #{postIdx}
  </delete>
  
   <delete id="chatDelete" parameterType="java.lang.Integer">
  	DELETE
  	FROM CHAT_MESSAGE
  	WHERE POST_IDX = #{postIdx}
  </delete>

  <select id="getPost" resultType="Post">
    SELECT PHOTOURL, POST_IDX AS POSTIDX, REGISTER_ID, PRICE, TITLE, CONTENT
     FROM POST
     WHERE REGISTER_ID = #{registerId} 
     AND NOT BORDER_TYPE = 'auction'
    </select>
    
    <select id="getPostIdx" resultType="Post">
    SELECT PHOTOURL, POST_IDX AS POSTIDX, REGISTER_ID, PRICE, TITLE, CONTENT, TRANSACTION_CONFIRMATION AS transactionConfirmation
     FROM POST
     WHERE POST_IDX = #{postIdx} 
    </select>

  <select id="getPostList" resultType="Post">
    SELECT PHOTOURL, POST_IDX AS POSTIDX, REGISTER_ID AS REGISTERID, PRICE, TITLE, CONTENT
     FROM POST
     WHERE NOT BORDER_TYPE = 'auction'
     AND TRANSACTION_CONFIRMATION = 'no'
    </select>
    
    <select id="selectPost" resultType="Post">
     SELECT PHOTOURL, POST_IDX AS POSTIDX, PRICE, TITLE, CONTENT, TRANSACTION_CONFIRMATION
     FROM POST
     WHERE POST_IDX = #{postIdx}
  </select>
    
    <select id="getCategory" resultType="Post" parameterType="java.lang.String">
    SELECT PHOTOURL, POST_IDX AS POSTIDX, REGISTER_ID AS REGISTERID, PRICE, TITLE, CONTENT, BORDER_TYPE
     FROM POST
     WHERE BORDER_TYPE = #{borderType}
       AND TRANSACTION_CONFIRMATION = 'no'
   
    </select>
    
    <select id="getPostListSize" resultType="Post">
    SELECT MAX(POST_IDX) AS POSTIDX
     FROM POST
    </select>
  
	<insert id="registerPost" parameterType="Post">
	INSERT INTO POST (post_Idx, register_Id, title, border_type, price, content, transaction_confirmation, photoUrl)
	 VALUES(#{postIdx}, #{registerId}, #{title}, #{borderType}, #{price}, #{content}, 'no', #{photoUrl})
	</insert>

	<update id="updatePost" parameterType="java.lang.Integer">
	  UPDATE POST
	  SET TRANSACTION_CONFIRMATION = 'WAIT'
	  WHERE POST_IDX = #{postIdx}
	</update>
	
    <select id="cartList" resultType="Post">
		SELECT P.TITLE, P.PRICE, P.TRANSACTION_CONFIRMATION AS TRANSACTIONCONFIRMATION
		FROM POST P
		         LEFT JOIN TRANSACTIONS T ON P.POST_IDX = T.POST_IDX
		WHERE T.BUYER_ID = #{buyerId, jdbcType=VARCHAR}
		  AND NOT P.BORDER_TYPE = 'auction'
		  AND P.TRANSACTION_CONFIRMATION = 'WAIT' 
    </select>
    
    <select id="getTitle" resultType="Post">
    	SELECT TITLE
    	FROM POST
    	WHERE POST_IDX = #{postIdx}
    </select>
    
</mapper>